# 17. 내용 협상과 트랜스코딩
## 17.1 내용 협상 기법
|기법|어떻게 동작하는가|장점|단점|
|:--:|:--:|:--:|:--:|
|클라이언트 주도|클라이언트가 요청을 보내면, 서버는 클라이언트에게 선택지를 보내주고, 클라이언트가 선택한다.|서버 입장에서 가장 구현하기 쉽다. 클라이언트는 최선의 선택을 할 수 있다.|대기시간이 증가한다. 즉, 올바른 콘텐츠를 얻으려면 최소 두번의 요청이 필요하다.|
|서버 주도|서버가 클라이언트의 요청 헤더를 검증해서 어떤 버전을 제공할지 결정한다.|클라이언트 주도 협상보다 빠르다. HTTP는 서버가 가장 적절한 것을 선택할 수 있도록 q값 메커니즘을 제공하고, 서버가 다운스트림 장치에게 요청이 어떻게 평가되는지 말해줄 수 있도록 하기 위해 Vary 헤더를 제공한다.|만약 결정이 빠르지 않으면(헤더에 맞는 것이 없으면), 서버는 추측을 해야만 한다.|
|투명|투명한 중간 장치(주로 프락시 캐시)가 서버를 대신하여 협상을 한다.|웹 서버가 협상을 할 필요가 없다. 클라이언트 주도 협상보다 빠르다.|투명 협상을 어떻게 하는지에 대한 정형화된 명세가 없다.|
## 17.2. 클라이언트 주도 협상
서버에게 가장 쉬운 방법은 서버가 클라이언트의 요청을 받았을 때 가능한 페이지의 목록을 응답으로 돌려주어 클라이언트가 보고 싶은 것을 선택하게 하는 것임

단점은 각 페이지에 두 번의 요청이 필요함(한 번은 목록, 두 번째는 선택한 사본)
## 17.3 서버 주도 협상
클라이언트 주도 협상은 대부분 요청에 대한 응답으로 돌려줄 최적의 페이지를 결정하기 위한 클라이언트와 서버 사이의 커뮤니케이션을 증가시킴

추가 커뮤니케이션을 줄이기 위해 서버가 어떤 페이지를 돌려줄 것인지 결정하게 할 수 있음

클라이언트는 무엇을 선호하는지에 대한 정보를 제공하기 위헤 헤더를 사용

- 내용 협상 헤더들을 살펴본다. 서버는 클라이언트의 Accept 관련 헤더들을 들여다보고 그에 알맞은 응답 헤더를 준비한다.
- 내용 협상 헤더 외에 다른 헤더들을 살펴본다.
### 17.3.1 내용 협상 헤더
|헤더|설명|엔터티 헤더|
|:--:|:--:|:--:|
|Accept|서버가 어떤 미디어 타입으로 보내도 되는지 알려준다.|Content-Type|
|Accept-Language|서버가 어떤 언어로 보내도 되는지 알려준다.|Content-Language|
|Accept-Charset|서버가 어떤 차셋으로 보내도 되는지 알려준다.|Content-Type|
|Accept-Encoding|서버가 어떤 인코딩으로 보내도 되는지 알려준다.|Content-Encoding|
### 17.3.2 내용 협상 헤더의 품질값
HTTP 프로토콜은 클라이언트가 각 선호의 카테고리마다 여러 선택 가능한 항목을 선호도와 함께 나열할 수 있도록 품질값을 정의
### 17.3.3 그 외의 헤더들에 의해 결정
서버는 또한 User-Agent와 같은 클라이언트의 다른 요청 헤더들을 이용해 알맞은 요청을 만들어내려고 시도 가능
### 17.3.4 아파치의 내용 협상
- 웹 사이트 디렉터리에서, variant를 갖는 웹 사이트의 각 URI를 위한 type-map 파일을 만든다. type-map 파일은 모든 variant와 그들 각각에 대응하는 내용 협상 헤더들을 나열한다.
- 아파치가 그 디렉터리에 대해 자동으로 type-map 파일을 생성하도록 하는 MultiViews 지시어를 켠다.
#### type-map 파일 사용하기
#### MultiViews 사용하기
### 17.3.5 서버 측 확장
## 17.4 투명 협상
투명 협상은 클라이언트 입장에서 협상하는 중개자 프락시를 둠으로써 클라이언트와의 메시지 교환을 최소화하는 동시에 서버 주도 협상으로 인한 부하를 서버에서 제거함
### 17.4.1 캐시와 얼터네이트(alternate)
### 17.4.2 Vary 헤더
## 17.5 트랜스코딩
서버는 클라이언트의 요구에 맞는 문서를 아예 갖고 있지 않다면 에러를 응답해야겠지만, 이론적으로 서버는 기존의 문서를 클라이언트가 사용할 수 있는 무언가로 변환하는 트랜스 코딩 옵션이 가능할 수도 있음
|전|후|
|:--:|:--:|
|HTML 문서|WML 문서|
|고해상도 이미지|저해상도 이미지|
|64K색 이미지|흑백 이미지|
|프레임을 포함한 복잡한 페이지|프레임이나 이미지가 없는 단순한 텍스트 페이지|
|자바 애플릿이 있는 HTML 페이지|자바 애플릿이 없는 페이지|
|광고가 있는 페이지|광고가 없는 페이지|
### 17.5.1 포맷 변환
데이터를 클라이언트가 볼 수 있도록 한 포맷에서 다른 포맷으로 변환
### 17.5.2 정보 합성
문서에서 정보의 요점을 추출
### 17.5.3 콘텐츠 주입
자동 광고 생성, 사용자 추적 시스템 등 웹 문서의 양을 늘리는 변환
### 17.5.4 트랜스코딩 vs. 정적으로 미리 생성해놓기
트랜스 코딩의 대안은 웹 서버에서 웹페이지의 여러 가지 사본을 만드는 것
## 17.6 다음 단계
- HTTP의 내용 협상은 성능 제약을 초래한다. 적절한 콘텐츠를 위해 여러 variant를 탐색하는 것이나, 혹은 가장 잘 맞는 것을 추측하려 하는 것은 비용이 클 수 있다.
- HTTP는 내용 협상이 필요한 유일한 프로토콜이 아니다.
## 17.7 추가 정보
