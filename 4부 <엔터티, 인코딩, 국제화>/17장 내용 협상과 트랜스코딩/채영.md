# 17 내용 협상과 트랜스코딩

내용 협상 = content-negotiation, 하나의 URL이 여러 가지 리소스 중 적합한 것에 대응되도록 함. 트랜스코딩은 HTTP클라이언트와 서버 사이의 내용 협상에 대한 응답에서 수행됨.

## 17.1 내용협상 기법

| 기법            | 어떻게 동작하는가                                                                        | 장점                                                                                                                                                                                                      | 단점                                                                  |
| --------------- | ---------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------- |
| 클라이언트 주도 | 클라이언트가 요청을 보내면 서버는 클라이언트에게 선택지를 보내주고, 클라이언트가 선택함. | 서버 입장에서 가장 구현하기 쉬움. 클라이언트는 최선의 선택을 할 수 있음                                                                                                                                   | 대기시간 증가<br>올바른 콘텐츠를 얻으려면 최소 두번의 요청이 필요함.  |
| 서버 주도       | 서버가 클라이언트의 요청 헤더를 검증해서 어떤 버전을 제공할지 결정함.                    | 클라이언트 주도 협상보다 빠름. HTTP 서버가 가장 적절한 것을 선택할 수 있도록 q=값 메커니즘을 제공하고, 서버가 다운스트림 장치에게 요청이 어떻게 평가되는지 말해줄 수 있도록 하기 위해 Vary 헤더를 제공함. | 결정이 뻔하지 않으면(헤더에 맞는 것이 없으면) 서버는 추측을 해야만함. |
| 투명            | 투명한 중간 장치가 서버를 대신하여 협상함 (주로 프락시 캐시)                             | 웹 서버가 협상을 할 필요가 없음. 클라이언트 주도 협상보다 빠름                                                                                                                                            | 투명 협상을 어떻게 하는지에 대한 정형화된 명세가 없음                 |

## 17.2 클라이언트 주도 협상

증가된 대기 시간과 페이지당 여러번의 요청이 필요한 것 외에 여러 개의 URL을 요구한다는 단점이 있음.

## 17.3 서버 주도 협상

HTTP 서버가 클라이언트에게 보내줄 적절한 응답을 계산하기 위해 사용하는 메커니즘은 두 가지.

- 내용 협상 헤더들을 살펴보고 서버는 클라이언트의 Accept 관련 헤더들을 들여다보고 그에 알맞은 응답 헤더를 준비함.
- 내용 협상 헤더 외의 다른 헤더들을 살펴봄. 서버는 클라이언트의 User-Agent 헤더에 기반하여 응답을 보내줄 수도 있음.

### 17.3.1 내용 협상 헤더

| 헤더            | 설명                                      | 엔터티 헤더      |
| --------------- | ----------------------------------------- | ---------------- |
| Accept          | 서버가 어떤 타입으로 보내도 되는지 알려줌 | Content-Type     |
| Accept-Language | 어떤 언어                                 | Content-Language |
| Accept-Charset  | 어떤 차셋                                 | Content-Charset  |
| Accept-Encoding | 어떤 인코딩                               | Content-Encoding |

### 17.3.2 내용 협상 헤더의 품질값

클라이언트가 선호하는 카테고리마다 선호도를 알 수 있는 품질값을 정의함

```
Accept-Language:en;q=0.5, fr;q=0.0, nl;q=1.0, tr;q=0.0
```

nl 네덜란드
tr 터키

### 17.3.3 그 외의 헤더들에 의해 결정

User-Agent와 같은 클라이언트의 다른 요청 헤더들을 이용해 알맞은 요청을 만들어내려고 시도할 수 있음.

### 17.3.4 아파치 내용 협상

type-map 파일 활용, MultiView사용하기

### 17.3.5 서버 측 확장

서버에서 내용 협상을 구현하는 또 다른 방법으로 마이크로소프트의 액티브 서버 페이지(ASP)와 같은 서버 쪽을 확장하는 방법이 있음.

## 17.4 투명 협상

프락시를 중개자로 둠으로써 클라이언트와 메시지 교환을 최소화하는 동시에 서버 주도 협상으로 인한 부하를 서버에서 제거함.

### 17.4.1 캐시와 얼터네이트(alternate)

캐시는 서버에게 응답을 이전 응답과 같이 그대로 전달하여 해당 URL에 대한 응답을 지난번 응답과 이번 응답 둘다 저장해야됨. 이 때 캐시는 같은 URL에 두 개의 다른 문서를 갖게됨. 이 다른 버전은 배리언트나 얼터네이트로 불림. 내용협상은 배리언트 중에서 클라이언트의 요청에 가장 알 맞는 것을 선택하는 과정으로 이해될 수 있음.

### 17.4.2 Vary 헤더

캐시는 각 배리언트마다 알맞은 문서 버전을 저장해야함. 캐시가 검색을 할 때, 먼저 내용 협상 헤더로 적합한 콘텐츠를 맞춰보고, 다음에 요청의 배리언트를 캐시된 배리언트와 맞춰봄.

## 17.5 트랜스코딩

서버가 클라이언트의 요구에 맞는 문서를 아예 갖고 있지 않다면 어떻게 되는가. 서버는 에러로 응답해야겠지만 이론적으로 서버는 기존의 문서를 클라이언트가 사용할 수 있는 무언가로 변환해야함.
|전|후|
|---|---|
|HTML|WML|
|고해상도 이미지|저해상도 이미지|

### 17.5.1 포맷 변환

User-Agent헤더에 의해서 주도될 수 있지만, 내용 변환 헤더에 의해 주도됨.

### 17.5.2 정보 합성

문서에서 정보의 요점을 추출하는 것을 정보 합성이라함.

### 17.5.3 콘텐츠 주입

내용 주입 트랜스코딩은 문서의 양을 늘리며 자동 광고 생성, 사용자 추적 시스템을 예로 들 수 있음.

### 17.5.4 트랜스코딩 VS 정적으로 미리 생성해놓기

트랜스코딩의 대안은 웹서버에서 웹 페이지의 여러 가지 사본을 만드는 것.

## 17.6 다음 단계

## 17.7 추가 정보
