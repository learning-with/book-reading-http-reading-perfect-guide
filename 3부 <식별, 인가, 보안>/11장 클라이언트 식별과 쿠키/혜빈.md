# 11. 클라이언트 식별과 쿠키

## 11.1 개별 접촉

HTTP의 특징
익명이다.

상태가 없다.

요청과 응답으로 통신한다.

(1) 사용자를 식별하거나, (2) 연속적인 요청을 추적하기 위해서는, 약간의 정보가 필요하다.

개인화 예
개별 인사 (ex. 우빈 님, 안녕하세요?)

사용자 맞춤 추천

주소, 신용카드 정보 입력 자동화 (cf. DB에 저장하기도 함)

세션 추적 (ex. 장바구니)

## 11.2 HTTP 헤더

## 11.3 클라이언트 IP 주소

사용자 식별에 클라이언트 IP 주소 사용 (ex. 인트라넷에서 특정 IP 주소에만 응답)

보통 HTTP 헤더에 IP 주소가 들어가지는 않음

웹 서버 HTTP 요청을 보내 반대쪽 TCP 커넥션의 IP 주소를 알아냄

IP 주소의 문제점
IP 주소는 사용자가 아니라 컴퓨터를 가리킨다. 여러 사용자가 같은 컴퓨터를 사용할 수 있다.

ISP는 동적으로 IP 주소를 할당한다.

많은 사용자가 NAT 방화벽을 통해 인터넷을 사용한다. NAT 장비들은 클라이언트들의 실제 IP 주소를 하나의 방화벽 IP 주소로 변환한다.

서버가 프락시나 게이트웨이와 연결되어 있는 경우, 서버는 클라이언트의 IP 주소 대신 프락시의 IP 주소를 본다. (프락시 확장 헤더(Client-ip, X-Forwarded-For)를 사용할 수도 있지만 모든 프락시가 그렇게 하지는 않는다.)

## 11.4 사용자 로그인

클라이언트가 요청

서버는 401 Login Required 응답과 WWW-Authenticate 헤더를 반환해 로그인 요청

사용자가 입력한 로그인 정보 토큰 Authorization 헤더에 담아 보냄 (ex. Authorization: Basic am910jRmdW4=)

추후 요청에 대해서는 서버가 요청하지 않아도 사용자 이름과 비밀번호를 포함해 전달해 세션이 진행되는 내내 사용자에 대한 식별을 유지함

사용자 로그인의 문제점
모든 사이트에 로그인하는 게 귀찮음

서로 다른 사용자 이름과 비밀번호를 기억해야 함

## 11.5 뚱뚱한 URL

사용자가 처음 방문하면 유일한 ID가 생성됨

URL 처음이나 끝에 ID를 추가함 ex. http://amazon.com/.../
002-1145265-801683

서버가 ID를 포함한 요청을 받으면 사용자와 관련된 추가적인 정보(ex. 장바구니, 프로필)를 찾고, 응답을 뚱뚱한 URL로 만듦

뚱뚱한 URL의 문제점
URL이 못생겨서 사용자 혼란

공유 불가: 공유하면 뚱뚱한 URL에 담긴 개인정보가 같이 공유됨

캐시 접근 불가: URL이 계속 달라지기 때문에 캐시를 사용할 수 없음

서버 부하 증가: 뚱뚱한 URL에 해당하는 각 페이지들을 새로 그려야 함

세션 지속 불가: 사용자가 뚱뚱한 URL을 북마크하지 않는 이상 로그아웃하면 모든 정보를 잃음

사용자가 세션에서 이탈하기 쉬움

## 11.6 쿠키

쿠키
사용자를 식별하고 세션을 유지하는 방식 중 가장 널리 사용됨

새로운 HTTP 헤더를 정의함

쿠키와 캐시가 충돌할 수 있어서 쿠키의 내용물은 캐싱하지 않음

### 11.6.1 쿠키의 타입

- 세션 쿠키: 사용자 설정과 선호를 저장하는 임시 쿠키.브라우저를 닫으면 삭제됨
- 지속 쿠키 : 주기적으로 방문하는 사이트에 대한 설정 정보나 로그인 유지. 디스크에 저장되어 브라우저나 컴퓨터 다시 시작해도 유지됨

### 11.6.2 쿠키는 어떻게 동작하는가

사용자가 웹 서버를 방문한다. 서버는 사용자에 대해 아무 것도 모른다.

서버는 사용자를 식별하기 위한 값을 쿠키에 할당한다.

쿠키는 이름=값 형태의 리스트이다.

서버는 이 리스트를 Set-Cookie 헤더에 담아 클라이언트에 전달한다.

브라우저는 서버에서 온 Set-Cookie 헤더에 있는 쿠키를 데이터베이스에 저장한다.

사용자가 나중에 같은 사이트를 방문하면 브라우저는 Cookie 헤더에 쿠키를 담아 전송한다.

우빈: Set-Cookie2 역시 RFC 2965에 따라 현재는 폐기되었습니다.

### 11.6.3 쿠키 상자: 클라이언트 측 상태

클라이언트 측 상태: 브라우저가 쿠키 정보를 저장하는 시스템

공식적으로는 HTTP 상태 관리 체계 (HTTP State Management Mechanism) 라고 불림

### 11.6.5 쿠키 구성요소

현재 사용되는 쿠키 명세는 RFC 6265이다. 이 책에서는 현재 쓰이지 않는 Version 0 쿠키(넷스케이프 쿠키), Version 1 쿠키(RFC 2965)를 다룬다.

### 11.6.9 쿠키와 캐싱

쿠키와 관련된 문서를 캐싱하면 사용자의 쿠키가 다른 사용자에게 할당되거나, 개인 정보가 노출될 수 있다.

Set-Cookie 빼고 캐시를 해도 된다면, 명시적으로 Cache-Control: no-cache="Set-Cookie"를 표시한다.

캐시를 해도 되는 문서에는 Cache-Control: public을 사용한다.

(서버의 응답에) 어떤 캐시는 Set-Cookie 헤더를 제거한다.

캐시가 모든 요청마다 원 서버에 재검사하도록 만들 수 있다.

재검사를 위해 Cache-Control: must-revalidate, max-age=0을 추가한다.

더 보수적인 캐시는 Set-Cookie를 가지고 있는 응답은 아예 캐싱하지 않는다.

(클라이언트의 요청에서) 보수적인 캐시는 Cookie 헤더가 있는 요청에 대한 응답은 캐시하지 않는다.

이미지는 캐싱하고 텍스트는 캐싱하지 않을 수도 있다.

이미지에 Max-age가 0인 Cookie 헤더를 설정해 매번 재검사하게 만들 수 있다.
