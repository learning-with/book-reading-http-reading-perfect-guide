# 11 클라이언트 식별과 쿠키

클라이언트 식별과 쿠키에서는 사용자를 식별하여 콘텐츠를 개인화시키는 기법을 다룸.

## 11.1 개별 접촉

개인에 맞춰진 사이트처럼 사용자 특화됨 메시지나 페이지 내용을 만들고 고객의 흥미가 무엇인지 학습하여 추천 상품을 만듬. 저장된 사용자 정보를 이용해 매번 입력하지 않도록 주소나, 신용카드 정보를 저장하고, 장바구니와 같은 기능같이 사용자 상태를 남겨둠.

## 11.2 HTTP 헤더

HTTP 요청 7가지

- `Form`, `User-Agent`, `Referer`, `Authorization`, `Client-ip` `X-Forwarded-For`, `Cookie`

- `Form` : 사용자 이메일 주소 포함
- `User-Agent` : 사용자가 쓰고 있는 브라우저의 이름과 버전 정보
- `Referer` : 사용자가 현재 페이지로 유입하게 한 웹페이지의 URL을 가리킴. 어떤 페이지를 방문했는지 알려줌.

## 11.3 클라이언트 IP 주소

사용자가 아닌 사용하는 컴퓨터를 가리킴. 임의로 IP 주소를 변경 가능하므로 문제가 발생할 수 있음. 문서 접근권한 강화는 14장에서 다룸.

## 11.4 사용자 로그인

로그인을 통해 사용자를 명시적으로 식별 요청을 할 수 있음.

## 11.5 뚱뚱한 URL

사용자 상태 정보를 포함하고 있는 URL을 뚱뚱한 URL이라고함.

- 웹 사이트를 처음 방문하면 유일한 ID가 생성됨. 그 값은 서버가 인식할 수 있는 방식으로 URL에 추가되며 서버는 클라이언트를 뚱뚱한 URL에 리다이렉트 시킴. 서버는 뚱뚱한 URL 요청을 받으면 사용자 아이디와 관련된 추가적인 정보를 찾아서 밖으로 향하는 모든 하이퍼링크를 뚱뚱한 URL로 바꿈

> 뚱뚱한 URL의 문제

- 못생긴 URL, 공유하지 못하는 URL, 캐시 사용 못함, 서버 부하 가중, 이탈, 세션 간 지속성의 부재

## 11.6 쿠키

쿠키는 캐시와 충돌할 수 있어서 대부분 캐시나 브라우저는 쿠키에 있는 내용물을 캐싱하지 않음

### 11.6.1 쿠키의 타입

세션 쿠키, 지속 쿠키 두 가지 타입으로 나눌 수 있음.

- **세션 쿠키** | 사용자가 사이트를 탐색할 때, 관련된 설정과 선호 사항들을 저장하는 임시 카테고리
- **지속 쿠키** | 삭제되지 않고, 더 길게 유지될 수 있음. 지속 쿠키는 디스크에 저장되어, 브라우저를 닫거나 컴퓨터를 브라우저를 닫거나 컴퓨터를 재시작하더라도 남아있음. 지속 쿠키는 사용자가 주기적으로 방문하는 사이트에 대한 설정 정보나 로그인 이름을 유지하려고 사용함.
- **둘의 차이** 파기되는 시점뿐! 쿠키는 Discard 파라미터가 설정되어 있거나, 파기되기까지 남은 시간을 가리키는 Expires 혹은 Max-Age 파라미터가 없으면 세션쿠키가됨.

### 11.6.2 쿠키는 어떻게 동작하는가

쿠키는 = 서버가 사용자에게 붙이는 식별 라벨

- 쿠키는 임의의 이름=값 형태의 리스트를 가지고 그 리스트는 Set-Cookie 혹은 Set-Cookie2(확장 헤더)같은 HTTP 응답 헤더에 기술되어 사용자에게 전달함.
- 쿠키는 어떤 정보든 포함할 수 있지만 서버가 사용자 추적 용도로 생성한 유일한 단순 식별 번호만 포함하기도함.
- 많은 웹 서버가 정보를 쿠키에 유지하려고 함.

```
Cookie :name="chaeyoung jin"; phone="123-1234"
```

쿠키 컨텐츠를 브라우저 쿠키 데이터베이스에 저장함. ( 여행가방에 붙은 수화물 표기 스티거라 생각하기 ) 같은 사이트 재 방문시 할당했던 쿠키를 Cookie요청 헤더에 기술해 전송.

### 11.6.3 쿠키상자 : 클라이언트 측 상태

클라이언트 측 상태 = HTTP 상태 관리 체계(HTTP state Management Mechanism): 브라우저는 쿠키 정보를 저장할 책임을 가짐.

> ### 크롬 브라우저 쿠키로 예시
>
> - `creaction_utc` 쿠키가 생성된 시점을 알려줌
> - `host_key` 쿠키 도메인
> - `name` 쿠키의 이름
> - `value` 쿠키의 값
> - `path` 쿠키와 관련된 도메인에 있는 경로
> - `expire_utc` 쿠키의 파기 시점을 알려줌.
> - `secure` SSL 커넥션일 경우에만 보낼지 가리킴.

> ### 마이크로소프트 익스플로러 쿠키
>
> 캐시 디렉터리에 각각의 개별 파일로 쿠키를 저장함.
>
> - 첫번째 줄: 쿠키의 이름
> - 두번째 줄 : 쿠키 값
> - 세번째 줄 : 도메인과 경로
> - 그 외 : 날짜나 표식같이 추가적인 정보들이 들어감.

### 11.6.4 사이트마다 각기 다른 쿠키

브라우저는 각 사이트에 두 개 혹은 세 개의 쿠키만 보내는 이유

- 모든 쿠키를 전달하면 성능 저하가 발생함.
- 쿠키를 모두 전달하면 브라우저는 실제 콘텐츠의 바이트보다 더 많은 쿠키 바이트를 전달하게 됨.
- 이 쿠키들 대부분은 서버에 특화된 이름/값 쌍을 포함하고 있기 때문에, 대부분 사이트에는 인식하지 않는 무의미한 값임.
- 모든 사이트에 쿠키 전체를 전달하는 것은 개인정보 문제를 방지하기 위함.

#### 쿠키 Domain 속성

domain 속성을 이용해 쿠키를 읽을 수 있는 사이트를 제어할 수 있음.

#### 쿠키 Path 속성

Path속성을 기술해서 해당 경로에 속하는 페이지에만 쿠키를 전달함.

### 11.6.5 쿠키 구성요소

### 11.6.6 Version 0 (넷스케이프) 쿠키

```
Set-Cookie : name=value [; expires = date][; path=path][;domain=domain][;secure]

Cookie: name 1 = value1 [;name2=value2] ...
```

최초의 쿠키명세는 넷스케이프가 정의함. Set-Cookie응답 헤더와 Cookie 요청 헤더와 쿠키를 조작하는데 필요한 필드들을 정의함.

> ### Version 0 Cookie 헤더

```
Cookie: session-id=002-1145265-8016838; session-id-time=1007884800
```

### 11.6.7 Version 1 (RFC 2965) 쿠키

쿠키의 확장된 버전. Version0과 호환됨. 아직 모든 브라우저가 지원하지 않음.

- 쿠키마다 목적을 설명하는 설명문이 있음.
- 파기 주기에 관계없이 브라우저가 닫히면 쿠키 강제 삭제 가능
- 절대 날짜값(1970.1.1기준) 대신 초 단위의 상대 값으로 쿠키의 생명주기를결정할 수 있는 Max-age
- 단순 도메인과 경로뿐 아니라 URL의 포트번호로도 쿠키를 제어할 수 있음.
- 도메인, 포트, 경로 필터가 있으면 Cookie 헤더에 담겨 되돌려 보냄.
- 호환되는 버전 번호
- 사용자 이름과 추가적인 키워드를 구별하기 위해 Cookie 헤더에 $접두사가 있음.

> ### Version 1 Cookie 헤더
>
> 현재 웹 사이트에 들어맞는 필터 정보에 달러 문자를 붙여서 쿠키와 함께 전송함.

- Version 1 Cookie2 헤더와 버전 협상

```
Cookie2: $Version="1"
```

Cookie2 요청 헤더는 각기 다른 쿠키 버전을 지원하는 클라이언트와 서버 간에 호환성을 협상하는 용도로 사용함. 서버가 새로운 형식의 쿠키를 인식하면 Cookie2 헤더를 받고 Set-Cookie가 아닌 응답 헤더를 보내야 함. 같은 쿠기가 올 경우 이전 방식인 Cookie를 무시함.

### 11.6.8 쿠키와 세션 추적

예시로는 장바구니 기능이 있음.

- 첫 접속 후 서버는 클라이언트를 전자상거리 소프트웨어 URL로 리다이렉트 시킴
- 서버 응답에 세션 쿠키를 기술하고 사용자를 다른 URL로 리다이렉트 시키며, 클라리언트는 해당 쿠키들을 첨부하여 요청을 보냄. 만약 클라이언트가 쿠키를 사용하지 않게 설정되어있다면 생성한 뚱뚱한 URL을 따라 리다이렉트 하면서도 사이트를 떠나지않는 한 식별 절차는 계속 됨.

### 11.6.9 쿠키와 캐싱

쿠키 트랜잭션과 관련된 문서를 캐싱하는 것은 주의해야함.
누군가의 개인 정보나 쿠키가 다른 이에게 노출되거나 할당돼버리는 상황 발생 할 수도 있음. 아래 규칙으로 유의하기

- 캐시되지 말아야 할 문서가 있다면 표시하기
- Set-Cookie 헤더를 캐시 하는 것에 유의하기
- Cookie 헤더를 가지고 있는 요청을 주의하기

### 11.6.10 쿠키, 보안 그리고 개인정보

개인정보를 누가 받는지 명확히 알고 사이트의 개인정보 정책만 유의한다면, 쿠키에 관련된 위험성보다 세션 조작이나 트랜잭션상의 편리함이 더 큼. 그래도 개인 정보는 유의하기.
