# 13 다이제스트 인증

기본 인증은 편리하고 유연하지만 안전하지 않음. 디이제스트 인증은 기본 인증과 호환되는 더 안전한 대체재로서 개발됨.

## 13.1 다이제스트 인증의 개선점

다이제스트 인증은 기본 인증의 가장 심각한 결함을 수정한 또 다른 HTTP 인증 프로토콜임. 가장 안전한 프로토콜은 아니지만 다이제스트 인증은 다른 인터넷 서비스를 위해 제안된 많은 인기 있는 보안 체계들(LDAP, POP, IMAP을 위해 제안된 CRAM-MD5)보다 더 강력함

> 다이제스트 인증의 특징

- 비밀번호는 절대 네트워크를 통해 평문으로 전송하지 않음
- 인증 체결을 가로채서 재현하려는 악의적인 사람들을 차단함
- 구현하기에 따라서 메시지 내용 위조를 막는 것도 가능
- 그 외 몇몇 잘 알려진 형태의 공격을 막음.

### 13.1.1 비밀번호를 안전하게 지키기 위해 요약 사용하기

### 13.1.2 단방향 요약

비밀번호를 모른다면 서버에게 보내줄 알맞은 요약을 추측하기 위해 끔찍하게 많은 시간을 소모하게 될 것이라는 점. 요약을 갖고 있다면 거의 무한개의 입력값들 중 그 요약을 생성하는 것을 찾기 위해 끔찍하게 많은 시간을 소모하게 됨.
요약함수는 보통 암호 체크섬(Cryptographic checksums)으로 불리며, 단방향 해시 함수이거나 지문 함수(fingerprint function)

### 13.1.3 재전송 방지를 위한 난스(nonce) 사용

단방향 요약은 비밀번호를 그대로 전송해야 할 필요성에서 우리를 해방시켜줌. 하지만 악의적인 집단에서 비밀번호를 모른다고 해도 요약을 가로채서 서버로 몇 번이고 재전송할 수 있기때문에 요약은 비밀번호 자체와 다름없음. 이런 재전송 공격을 방지하기 위해 서버는 클라이언트에게 난스라고 불리는 특별하고 자주 바뀌는(대략 1밀리초마다, 혹은 인증할 때마다) 증표를 건내줌. 난스를 비밀번호에 섰으면 난스가 바뀔 때마다 요약도 바뀌게 만들어줌. 난스는 WWW-Authenticate인증 요구에 담겨서 서버에서 클라이언트로 전송됨.

### 13.1.4 다이제스트 인증 핸드셰이크

다이제스트 인증은 기존 헤더에 몇몇 새 옵션이 추가되었고, 선택적인 헤더인 Authorization-Info가 추가되었음.

- 1단계 서버는 난스 값을 계산함
- 2단계 서버는 WWW-Authenticate인증 요구 메시지에 담아, 서버가 지원하는 알고리즘 목록과 함께 클라이언트에 전송
- 3단계 클라이언트는 알고리즘을 선택하고 비밀번호와 그 외 데이터에 대한 요약을 계산.
- 4단계 클라이언트는 Authorization메시지에 요약을 담아 서버에게 돌려줌. 만약 클라이언트가 서버를 인증하길 원한다면 클라이언트 난스를 보낼 수 있음
- 5단계 서버는 요약, 선택한 알고리즘, 그 외 보조 데이터들을 받고, 클라이언트가 했던 그대로 요약을 서로 같은지 확인함. 만약 클라이언트가 대칭적으로 서버에게 클라이언트 난스를 갖고 인증을 요구했다면, 클라이언트 요약이 만들어짐. 또한 서버는 클라이언트가 미리 다음번 요약을 생성할 수 있도록 다음번 난스를 미리 계산해서 클라이언트에게 넘겨줄 수도 있음.

## 13.2 요약 계산

다이제스트 인증의 핵심은 공개된 정보, 비밀 정보, 시한부 난스 값을 조합한 단방향 요약임

### 13.2.1 요약 알고리즘 입력 데이터

- 단방향 해시 함수 H(d)와 요약 함수 KD(s,d). 여기서 s는 비밀(secret)을, d는 데이터(data)를 의미함.
- 비밀번호 등 보안 정보를 담고 있는 데이터 덩어리. A1이라 칭함.
- 요청 메시지의 비밀의 비밀이 아닌 속성을 담고 있는 데이터 덩어리. A2라 칭함.

> A1,A2 두 조각의 데이터는 요약을 생성하기 위해 H와 KD에 의해 처리됨.

### 13.2.2 H(d)와 KD(s,d)알고리즘

여러가지 요약 알고리즘을 선택할 수 있도록 지원하지만 정해지지 않았다면 MD5가 기본값임.

### 13.2.3 보안 관련 데이터(A1)

사용자 이름, 비밀번호, 보호영역, 난스와 같은 비밀 보호 정보로 이루어진 데이터

### 13.2.4 메시지 관련 데이터(A2)

URL, 요청 메서드, 메시지 엔터티 본문과 같은 메시지 자체의 정보를 나타냄.

### 13.2.5 요약 알고리즘 전반

RFC2617은 주어진 H, KD, A1, A2로 요약을 계산하는 두 가지 방법을 정의함.

- 첫 번째 방법은 예전 명세인 RFC2069와 호환을 염두에 둔 것으로 qop옵션이 빠졌을 때 사용됨. 비밀 정보와 난스가 붙은 메시지 데이터의 해시를 이용해 요약을 계산함.
- 두 번째 방법은 현대적이면서 보다 선호되는 접근법으로 난스 횟수 집계 및 대칭 인증의 지원을 포함함. 이 접근법은 qop가 'auth'일 때와 'auth-int'일 때 모두 사용됨. 난스 횟수, qop, c난스 데이터를 요약에 추가함.
  |qop|알고리즘|펼쳐진 알고리즘|
  |-----|-----|------|
  |정의되지 않음|<정의되지 않음><br>MD5<br>MD5-sess|MD5(MD5(A1):<난스>:MD5(A2))|
  |auth|<정의되지 않음><br>MD5<br>MD5-sess|MD5(MD5(A1):<난스>:`<nc>`:<난스>:`<qop>`:MD5(A2))|
  |auth-int|<정의되지 않음><br>MD5<br>MD5-sess|MD5(MD5(A1):<난스>:`<nc>`:<난스>:`<qop>`:MD5(A2))|

### 13.2.6 다이제스트 인증 세션

클라이언트가 보호 공간의 다른 서버로부터 또 다른 WWW-Authenticate인증 요구를 받을 때까지 지속됨.
난스가 만료되면, 서버는 포함된 난스 값이 낡은 것일 수 있음을 감수하고 오래된 Authorization 헤더 정보를 받아들이는 것을 택할 수 있음. 또는 서버는 클라이언트가 다시 요청을 보내도록 새 난스 값과 함께 401응답을 반환할 수도 있음. 이때 이 응답에 `stale=true`로 정의함으로 서버는 클라이언트에게 사용자 이름과 비밀번호를 새로 입력하도록 창을 띄울 필요 없이 새 난스 값으로 요청을 보내라고 말해줄 수 있음.

### 13.2.7 사전(preemptive) 인가

클라이언트가 다음 난스가 무엇이 될지 미리 알고 있어서, 서버가 물어보기 전에 올바른 Authorization 헤더를 생성할 수 있다면 요구/인증 요구 사이클 생략가능함.

> 다이제스트 인증에서 여러 안전한 기능을 유지하면서 사전 인가를 할 수 있는 방법.

1. **다음 난스 미리 생성하기** 서버가 다음 난스를 Authentication-Info 성공 헤더에 담아서 미리 보냄.
2. **제한된 난스 재사용** 서버가 짧은 시간 동안 같은 난스를 재사용하는 것을 허용함
3. **동기화된 난스 생성** 클라이언트와 서버가 동기화되어 있고 예측 가능한 난스 생성 알고리즘을 사용함.

### 13.2.8 난스 선택

난스 내용은 불투명하고 구현 의존적임.

```
BASE64(타임스템프 H (타임스템프)":" ETag":"개인 키)
```

타임스탬프는 서버에서 생성된 시간 혹은 아무것이나 반복 불가능한 값이면 되고, ETag는 요청된 엔터티에 대한 ETag헤더값이며, 개인 키는 서버만이 알고 있는 값임.
재전송 공격을 방지하기 위해, 어떤 구현은 이전에 사용된 난스나 요약을 받아들이지 않도록 결정할 수 있음.

### 13.2.9 상호 인증

RFC2617로 표준화됨.

## 13.3 보호 수준(Quality of Protection) 향상

- qop 필드는 클라와 서버가 어떤 보호 기법을 어느 정도 수준으로 사용할 것인지 협상할 수 있게 해줌.
- 서버는 우선 WWW-Authenticate 헤더에 qop 옵션을 수비표로 구분된 목록 형태로 내보냄.
- 클라는 그 옵션들 중 지원할 수 있으면서 동시에 자신의 요구에도 맞는 것을 선택하고 Authorization 헤더의 qop 필드에 담아 돌려줌.
- 인증을 의미하는 auth와 메세지 무결성 보호를 의미하는 auth-init.

### 13.3.1 메시지 무결성 보호

무결성 보호가 적용되었을 때(qop="auth-int") 계산되는 H(엔터티 본문)는 메시지 본문의 해시가 아닌 엔터티 본문의 해시임.

### 13.3.2 다이제스트 인증 헤더

다이제스트 인증은 선택적인 Authentication-Info 헤더를 추가함.
Authentication-Info 헤더는 3단계 핸드셰이크를 완성하고 다음번 사용할 난스를 전달하기 위해 인증 성공 후에 전송됨.

## 13.4 실제 상황에 대한 고려

### 13.4.1 다중 인증요구

서버는 한 리소스에 대해 여러 인증을 요구할 수 있음. 다양한 인증 옵션을 제공하는 경우, 가장 허약한 연결 부분에 대한 보안 우려가 있다는 것이 명확함으로 서버는 기본 인증을 제한적으로 사용해야함. 관리자는 사용자에게 보안 수준이 다른 여러 시스템에서 같은 비밀번호를 사용하는 것의 위험성에 대해 경고해야함.

### 13.4.2 오류 처리

값이 적절하지 않거나 요구된 지시자가 빠져있으면 400BadRequest임. 공격의 징후일 수 있으므로 해당 에러에 대한 로그를 남길 수도 있음. 요청 URL과의 중복된 정보는 중간의 프락시가 클라이언트의 요청줄을 변조했을 가능성에 대처할 수 있게 해줌. 변형된 요청의 요약을 계산한 결과는 클라이언트가 계산한 요약과 다를 것임.

### 13.4.3 보호 공간(Protection Space)

영역값은 접근한 서버의 루투 URL과 결합되어 보호 공간을 정의함.

- 기본 인증에서 클라이언트는 요청 URI와 그 하위의 모든 경로는 같은 보호 공간에 있는 것으로 가정함. 클라이언트는 이 공간에서 서버로부터의 또 다른 인증요구를 기다리지 않고 미리 리소스에 대한 인가를 받을 수 있음
- 다이제스트 인증에서 인증요구의 WWW-Authenticate:domain 필드는 보호 공간을 보다 엄밀하게 정의함.

### 13.4.4 URI 다시 쓰기

프락시는 가리키는 리소스의 변경 없이 구문만 고쳐서 URI를 다시 쓰기도 함. 프락시가 URI변경할 수 있는 동시에 다이제스트 인증은 URI값의 무결성을 검사함. 이때 다이제스트 인증이 변경에 의해 실패할 수도 있음.

- 호스트 명은 정규화되거나 IP주소로 대체될 수 있음
- 문자들은 `%`escape 형식으로 대체될 수 있음
- 특정 원 서버로부터 가져오는 리소스에 영향을 주지 않는, 타입에 대한 추가 속성이 URI의 끝에 붙거나 중간에 삽입될 수 있음

### 13.4.5 캐시

어떤 공유 캐시가 Authorization 헤더를 포함한 요청과 그에 대한 응답을 받은 경우 두 Cache-Control 지시자 중 하나가 응답에 존재하지 않는 한 다른 요청에 대해 그 응답을 반환해서는 안됨.

## 13.5 보안에 대한 고려사항

### 13.5.1 헤더 부당 변경

항상 안전한 시스템을 제공하기 위해서 양 종단 암호화나 헤더에 대한 디지털 서명이 필요함.

### 13.5.2 재전송 공격

어떤 트랜잭션에서 엿들은 인증 자격을 다른 트랜잭션을 위해 사용하는 것을 말함. 해당 문제를 완화시키는 방법 중 하나는 클라이언트의 IP주소, 타임스템프, 리소스의 ETag, 개인 서버 키에 대한 요약을 포함하는 난스를 서버가 생성하도록 하는 것임. 단 이 방법에는 나스 생성 시 클라이언트 IP를 사용하게 되면 같은 사용자로부터 요청이 다른 프락시를 통과하게 될 수 있어 프락시 팜은 사용할 수 없음.

- 재전송 공격을 완전히 피할 수 있는 방법은 매 트랜잭션마다 유일한 난스값을 사용하는 것임. 서버에 부하를 가중시킬 수 있지만 사소한 수준일 것임.

### 13.5.3 다중 인증 메커니즘

기본과 요약을 모두 지원, WWW-Authenticate헤더를 통해 선택지 제공. 모든 클라이언트들이 인증 방법을 가장 강력한걸 사용하는 것이 확실한 방법이지만 해당 방법은 사내 네트워크 정도에서만 실현 가능함.

### 13.5.4 사전(dictionary) 공격

비밀번호 추측 공격 -> 비밀번호 만료 정책 외에는 대책이 실직적으로 없음.

### 13.5.5 악의적인 프락시와 중간자 공격(Man-in-the-Middle Attack)

가능한 해결책은 시각적으로 인증 강도를 보여주는 것. 또는 SSL 사용하기

### 13.5.6 선택 평문 공격

응답을 계산하기 위해 알려진 키를 사용하면 응답의 암호 해독이 쉽게 가능함. 아래 방법은 쉽게 방어할 수 있음, 강력한 비밀번호를 강제하는 정책과 좋은 비밀번호 만료 매커니즘이 더해지면, 선택 평문 공격의 위협은 완전히 경감가능.

- 미리 계산된 사전 공격
- 자동화된 무차별 대입 공격

### 13.5.7 비밀번호 저장

유닉스 장치의 전통적인 비밀번호 파일과는 달리, 다이제스트 인증 비밀번호 파일이 유출되면 영역의 모든 문서는 즉각 공격자에게 노출됨.

> 해결방법

- 비밀번호 파일이 평문으로 된 비밀번호 파일이 유출되더라도 피해를 특정 영역으로 국소화함. 호스트와 도메인을 포함한 완전한 영역 이름은 이 요구를 만족함.

#### 다이제스트 인증

기본 인증에 비해 훨씬 탄탄하고 안전한 해결책을 제공함에도, 콘텐츠 측면에서는 어떠한 보호도 제공하지 못함. 진정한 트랜잭션은 오로지 SSL통해서만 가능!
