# 06 프락시

## 6.1 웹 중개자

클라이언트 입장에서 트랜잭션을 수행하는 중개인.

- 프락시는 클라이언트 입장에서 트랜잭션을 수행하는 중개인인데, 트랜잭션을 완료하는 것은 클라이언트라는 사실은 변하지 않음. HTTP 프락시는 웹서버이기도 하고 웹 클라이언트 서버이기도 함. 클라이언트 측에서는 웹 서버 처럼 요청 메시지를 받고 응답 메시지를 돌려줌. 웹 서버 입장에서는 클라이언트처럼 동작하면서 웹 요청 메시지를 보내고 웹 응답 메시지를 받음

### 6.1.1 개인 프락시와 공유 프락시

#### 공용 프락시

대부분의 프락시는 공용이며, 프락시를 이용하는 사용자가 많을수록 여러 사용자들의 공통된 요청에서 이득을 취할 수 있어 유리함.

#### 개인 프라기

흔하지는 않지만 주로 클라이언트 컴퓨터에서 직접 실행되는 형태로 꾸준히 사용되고 있음. 브라우저의 기능을 확장하거나 성능을 개선하거나 무료 ISP 서비스를 위한 광고 운영을 위해 작은 프락시를 사용자 컴퓨터에서 실행함.

### 6.1.2 프락시 VS 게이트웨이

프락시는 같은 프로토콜을 사용하는 둘 이상의 애플리케이션을 연결함. 게이트웨이는 서로 다른 프로토콜을 사용하는 둘 이상을 연결함. 하지만 때때로 프락시가 약간의 프로토콜 변환을 하기도함. 몇몇 상용 프락시 서버는 SSL 보안 프로토콜, SOCKS 방화벽, FTP 접근, 웹 기반 애플리케이션을 지원하기 위해 게이트웨이 기능을 구현함.

## 6.2 왜 프락시를 사용하는 가?

프락시 서버는 모든 HTTP 트래픽을 들여다보고 건드릴 수 있기 때문에 프락시는 부가적인 가치를 주는 유용한 웹 서비스를 위해 트래픽을 감시하고 수정할 수 있음.

- 사용자에 따라 콘텐츠를 필터링해주기도 함.(ex: **어린이 필터** 프락시로 부적절한 사이트 차단하기 등)
- 웹 서버들과 웹 리소스에 대한 단일한 접근 제어 전략을 구현, 감사 추적(audit trail)을 위해 사용. **문서 접근 제어자**는 다양한 웹 서버들에 대해 접근 제어를 수시로 갱신할 필요없이, 중앙 프락시 서버에서 접근 제어를 설정할 수 있음.
- **보안 방화벽**으로 사용되는 프락시 서버는 조직 안에 들어오거나 나가는 응용 레벨 프로토콜의 흐름을 네트워크의 한 지점에서 통제함. 트래픽을 세심히 살펴볼 수 있는 후쿠(Hook)를 제공함.
- **웹 캐시**는 인기 있는 문서의 로컬 사본을 관리하고 해당 문서에 대한 요청이 오면 빠르게 제공하여 느리고 비싼 인터넷 커뮤니케이션을 줄임.
- **대리 프락시(리버스 프락시)** 서버 가속기라도 불리는데, 공용 콘텐츠에 대한 느린 웹 서버 성능 개선을 위해 웹 서버 요청을 받아 요청 받은 콘텐츠 위치를 찾아내기 위해 다른 서버와 커뮤니케이션을 함. 또한 콘텐츠 라우팅 기능과 결합되어 주문형 복제 콘텐츠의 분산 네트워크를 만들기 위해 사용될 수 있음.
- **콘텐츠 라우터** 프락시 서버는 인터넷 트래픽 조건과 콘텐츠의 종류에 따라 요청을 특정 웹 서버로 유도하는 콘텐츠 라우터로 동작할 수 있음. 콘텐츠 라우터는 요청을 가까운 복제 캐시로 전달할 수 있음.
- **트랜스코더** 트랜스코딩 프락시는 크기를 줄이기 위해 자신을 거쳐 가는 GIF이미지를 JPG 이미지로 변환할 수 있음.
- **익명화 프락시** HTTP 메시지에서 신원을 식별할 수 있는 특성들을 적극적으로 제거함으로써 개인 정보 보호와 익명성 보장에 기여함.

## 6.3 프락시는 어디에 있는가?

어떻게 사용할지에 따라서 프락시는 어디에든 배치할 수 있음.

### 6.3.1 프락시 서버 배치

- 출구 프락시
- 접근(입구) 프락시
- 대리 프락시
- 네트워크 교환 프락시

### 6.3.2 프락시 계층

- 프락시들은 프락시 계층이라고 불리는 연쇄를 구성할 수 있음
- 프락시 계층에서 프락시 서버들은 부모와 자식 관계를 가짐.
- 인바운드 프락시( 서버와 가까운 쪽 )을 부모, 아웃바운드 프락시( 클라이언트 가까운 쪽 )를 자식이라고 부름.

#### 프락시 계층 콘텐츠 라우팅

프락시 계층은 정적일 수도 있고 유동적일 수도 있음.

- 부하 균형
- 지리적 인접성에 근거한 라우팅
- 프로토콜/타입 라우팅
- 유료 서비스 가입자를 위한 라우팅

### 6.3.3 어떻게 프락시가 트래픽을 처리하는가

클라이언트 트래픽이 프락시로 가도록 만드는 방법

1. 클라이언트 수정하기.
2. 네트워크 수정하기
3. DNS 이름 공간 수정하기
4. 웹 서버 수정하기

## 6.4 클라이언트 프락시 설정

설정하는 방법

- 수동 설정
- 브라우저 기본 설정
- 프락시 자동 설정 (Proxy-auto-configuration, PAC)
- WPAD 프락시 발견

### 6.4.1 클라이언트 프락시 설정 : 수동

프락시를 사용하겠다고 명시적으로 설정함.
크롬의 경우 설정에서 프록시 설정 변경이 가능함. 몇몇 ISP는 그들의 요구에 맞춰 미리 설정된 브라우저나 웹 트래픽을 프락시 서버로 리다이렉트 하는 맞춤형 운영 체제를 구입함.

> ISP(internet Service Provider)
>
> - 인터넷 서비스 제공자, 인터넷 회사라고 함.
> - Kt, LG유플러스, SK브로드밴드 등의 대형 사업자 또는 삼성 SDS, LG CNS, 효성 ITX 등등의 대기업 계열의 IT서비스 기업 등이 인터넷 서비스를 제공중임.

### 6.4.2 클라이언트 프락시 설정 : PAC 파일

수동 프락시 설정은 단순하지만 유연하지 못함.

#### 수동 프락시의 단점

- 모든 콘텐츠를 위해 단 하나의 프락시 서버만을 지정할 수 있음
- 장애 시의 대체 작동에 대한 지원 X
- 수동 프락시 설정은 큰 조직에서 관리 문제를 야기함.
- 설정된 브라우저가 매우 많다면 ㄱ모두를 원하는 대로 설정 변경을 하는 것은 어렵거나 불가능함.

#### 해결 방법은 PAC파일!

PAC파일은 프락시 설정을 그때그때 상황에 맞게 계산해주는 작은 자바스크립트 프로그램이므로 프락시 설정에 대한 보다 동적인 해결책.

- 설정 방법 : 자바스크립트 PAC파일을 URI브라우저에 설정해야함. 설정은 수동과 비슷하지만 '자동 설정' 상자에 URI를 제공해줘야함.
- 브라우저는 URI로부터 PAC파일을 가져와서 매 접근마다 적절한 프락시 서버를 계산하기 위해 자바스크립트 로직을 이용할 것임.
- 각 PAC파일은 반드시 URI에 접근할 때, 사용할 적절한 프락시 서버를 계산해주는 FindProxyForUri(url, host)라는 함수를 정의해야함.
  |FindProxyForURL 반환값|설명|
  |--------------|-----------|
  |DIRECT| 프락시 없이 연결이 직접 이루어져야 함|
  |PROCY host:port|지정한 프락시를 사용해야 함|
  |SOCKS host:port | 지정한 SOCKS 서버를 사용해야 함|

PAC파일은 HTTP 트랜잭션과 FTP 트랜잭션에 대해 각각 사용할 프락시를 알려줌.

### 6.4.3 클라이언트 프락시 설정 : WPAD

웹 프락시 자동발견 프로토콜을 WPAD라고함.
WPAD는 여러 발견 메커니즘들의 상승 전략을 이용해 브라우저에 알맞은 PAC파일을 자동으로 찾아주는 알고리즘.

#### WPAD프로토콜이 구현된 클라이언트가 하게 될 일

- PAC URI를 찾기위해 WPAD를 사용
- 주어진 URI에서 PAC파일을 가져옴
- 프락시 서버를 알아내기 위해 PAC파일을 실행함.
- 알아낸 프락시 서버를 이용해서 요청을 처리함.

> WPAD명세 정의 순서

- 동적 호스트 발견 규약(DHCP)
- 서비스 위치 규약(SLP)
- DNS 잘 알려진 호스트 명
- DNS SRV 레코드
- DNS TXT 레코드 안의 서비스 URI
  > 모든 조직이 모든 기법을 사용할 수 있는 것이 아니기 떄문에 WPAD는 설공할 때까지 각 기법을 하나씩 시도해봄.

## 6.5 프락시 요청의 미묘한 특징들

### 6.5.1 프락시 URI는 서버 URI와 다르다.

웹 서버와 웹 프락시 메시지의 문법은 서로 같지만, 클라이언트가 프락시 대신 서버로 요청을 보내면 요청 URI가 달라짐.
클라이언트가 웹 서버로 요청을 보낼 때, 요청 줄은 스킴, 호스트, 포트번호가 없는 부분 URI를 가짐. 클라이언트가 프락시로 요청을 보낼 때, 요청줄은 완전한 URI를 가짐.

#### 서버 URI와 프락시 URI가 다른 이유는 초기 HTTP 설계에서 부분 URI로 소통을 했기 때문, 완전한 URI로 바꾸기에는 이미 너무 많은 서버가 배치되어 있음.

HTTP/1.1은 현재 서버들이 완전한 URI서버를 다룰 것을 요구하지만, 현실에서는 배치 되어 있는 서버들 중 다수가 여전히 부분 URI만 받아들임.

### 6.5.2 가상 호스팅에서 일어나는 같은 문제

스킴/호스트/포트번호 누락 문제는 가상으로 호스팅 되는 웹 서버가 직면한 것과 같은 문제.
비슷하지만 각각 다른 방법으로 해결됨.

- 명시적인 프락시는 요청 메시지가 완전한 URI를 갖도록 함으로써 이 문제를 해결함
- 가상으로 호스팅 되는 웹 서버는 호스트와 포트에 대한 정보가 담겨 있는 Host헤더를 요구함.

### 6.5.3 인터셉트 프락시는 부분 URI를 받는다.

클라이언트는 자신이 프락시와 대화하고 있음을 항상 알고 있는 것은 아님. 몇몇 프락시는 클라이언트에게는 보이지 않을 수 있기 떄문.클라이언트가 프락시를 사용한다고 설정되어 있지 않아도, 클라이언트의 트래픽은 여전히 대리 프락시나 인터셉트 프락시를 지날 수 있음. 이런 경우 클라이언트는 자신이 웹 서버와 대화하고 있다고 생각하고 완전한 URI를 보내지 않을 것임.

- 대리 프락시는 앞에 설명한 바와 같이 원 ㅅ ㅓ버의 호스트 명과 아이피 주소를 사용해 원 서버를 대신하는 프락시 서버
- 인터셉트 프락시는 네트워크 흐름에서 클라이언트에서 서버로 가는 트래픽을 가로채 캐시된 응답을 돌려주는 등의 일을 하는 프락시 서버, 인터셉트 프락시는 클라이언트에서 서버로 가는 트래픽을 가로채기 때문에, 웹 서버로 보내는 부분 URI를 얻을 것임.

### 6.5.4 프락시는 프락시 요청과 서버 요청을 모두 다룰 수 있다

트래픽이 프락시 서버로 리다이렉트 될 수 있는 여러 방법이 존재하기 때문에 다목적 프락시 서버는 요청 메시지의 완전한 URI와 부분 URI를 모두 지원해야함.
웹 서버 요청의 경우에는 가상 Host헤더를 사용해야 함. Host헤더에서 원 서버의 이름과 포트 번호를 알아내야 함.

- 프락시가 원 서버를 대신하는 대리 프락시라면 프락시에 설계 서버의 주소와 포트 번호가 설정되어 있을 수 있음.
- 이전에 어떤 인터셉트 프락시가 가로챘던 트래픽을 받았고, 그 인터셉트 프락시가 원 IP주소와 포트 번호를 사용할 수 있도록 해두었다면, 그 IP 주소와 포트번호를 사용할 수 있음.
- 모두 실패할 경우, 프락시는 원 서버를 알아낼 수 있는 충분한 정보를 갖고 있지 못한 것이므로 반드시 에러 메시지를 반환해야 함. ( 에러 메시지는 브라우저 업그레이드를 해주세요 알고 알려주는 형태로 제공됨. )

### 6.5.5 전송 중 URI 변경

사소한 URI변경이라도 다운 스트림 서버와 상호운용성 문제를 일으킬 수 있기때문에 요청 URI 변경할 시 주의해야함.
몇몇 프락시는 URI를 다음 홉으로 보내기 전에 표준 형식으로 정규화하면서 잘못 시용한 예약된 글자를 올바르게 이스케이프하여 교체하는 것과 같은 무해해 보이는 변형일지라도 상호 운용성 문제를 일으킬 수 있음. 특히 HTTP 명세는 일반적인 인터셉트 프락시가 URI를전달할 때 절대 경로를 고쳐 쓰는 것을 금지함. 유일한 예외는 빈 경로를 `/`로 교체하는 것 뿐.

### 6.5.6 URI 클라이언트 자동확장과 호스트 명 분석 (Hostname Resolution)

브라우저는 프락시의 존재 여부에 따라 요청 URI를 다르게 분석하는데, 프락시가 없다면 사용자가 타이핑한 URI를 가지고 그에 대응하는 IP주소를 찾음. 호스트가 발견되지 않는다면 자동 확장으로 `www.`이나 `.com` 같은 접두미사를 붙인다.

### 6.5.7 프락시 없는 URI 분석(URI Resolution)

브라우저는 유효한 호스트 명이 발견될 때까지 다양한 호스트명의 가능성들을 검색함. (자동확장)

### 6.5.8 명시적인 프락시를 사용할 때의 URI 분석

만약 명시적인 URI를 사용한다면, 브라우저는 편리한 확장기능 중 어느것도 사용할 수 없음. 몇몇 프락시는 자동확장이나 지역 도메인 접미사 추가와 같은 브라우저의 편리한 서비스를 할 수 있다면 최대한 흉내 내려고 시도함.

### 6.5.9 인터셉트 프락시를 이용한 URI 분석

호스트명 분석은 인터셉트 프락시와 함께일 대 약간 달라지는데 클라이언트 입장에서 프락시는 존재하지 않는 것이기 때문임. 호스트명을 자동확장할 때 동작은 프락시와 웹서버으 ㅣ경우와 별차이가 없지만 서버로의 커넥션이 만들어 졌을 대는 분명한 차이가 발생함.

## 6.6 메시지 추적

### 6.6.1 Via 헤더

### 6.6.2 TRACE 메서드

## 6.7 프락시 인증

## 6.8 프락시 상호운용성

### 6.8.1 지원하지 않는 헤더와 메서드 다루기

### 6.8.2 OPTIONS: 어떤 기능을 지원하는지 알아보기

### 6.8.3 Allow 헤더

## 6.9 추가 정보
