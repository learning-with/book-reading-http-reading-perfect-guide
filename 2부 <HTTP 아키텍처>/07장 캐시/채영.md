# 07 캐시

웹 캐시 : 자주 쓰이는 문서의 사본을 자동으로 보관하는 HTTP 장치

- 캐시는 불필요한 데이터 전송을 줄여서, 네트워크 요금으로 인한 비용을 줄여줌
- 캐시는 네트워크 병목을 줄여줌. 대역폭을 늘리지 않고도 페이지를 빨리 불러올 수 있게 됨.
- 캐시는 원 서버에 대한 요청을 줄여줌 서버는 부하를 줄일 수 있으며 더 빨리 응답할 수 있게 됨
- 페이지를 먼 곳에서 불러올수록 시간이 많이 걸리는데, 캐시는 거리로 인한 지연을 줄여줌.

> 효과 측정, 효과 극대화를 위한 캐시 위치, HTTP가 어떻게 캐시된 사본을 유지하는지, 캐시가 다른 캐시나 서버와 상호작용하는 방법에 대해 알아보자.

## 7.1 불필요한 데이터 전송

불필요한 데이터 전송은 값비싼 네트워크 대역폭을 잡아먹고, 전송을 느리게 만들며, 웹 서버에 부하를 줌.

- 캐시된 사본이 뒤이은 요청들에 대한 응답으로 사용될 수 있기 때문에, 원 서버가 중복해서 트래픽을 주고받는 낭비가 줄어들게 됨.

## 7.2 대역폭 병목

많은 네트워크가 원격 서버보다 로컬 네트워크 클라이언트에 더 넓은 대역폭을 제공함. 클라이언트들이 서버에 접근할 때 속도는 그 경로에 있는 가장 느린 네트워크의 속도와 같음. 대역폭은 네트워크 속도와 문서에 따라 전송 시간에 많은 영향을 줌.

- 클라이언트가 빠른 LAN에 있는 캐시로부터 사본을 가져온다면, 캐싱은 성능을 대폭 개선할 수 있음.

## 7.3 갑작스런 요청 쇄도(Flash Crowds)

갑작스런 사건, 속보, 스팸 메일, 유명 인사와 관련된 사건 등으로 인해 많은 사람이 거의 동시에 웹 문서에 접근할 때 이런 일이 발생함. 캐싱은 갑작스런 요청 쇄도에 대처하기 위해 특히 중요함.

## 7.4 거리로 인한 지연

모든 네트워크 라우터는 제각각 인터넷 트래픽을 지연시킴. 보통 수준으로 복잡한 웹페이지들은 빛의 속도로 인한 지연이 수 초에 달할 수도 있음. 기계실 근처에 캐시를 설치해서 문서가 전송되는 거리를 수천 킬로미터에서 수십미터로 줄일 수 있음.

## 7.5 적중과 부적중

캐시가 세상 모든 무너의 사본을 저장하지는 않음.

- cache hit = 캐시적중 : 캐시에 요청이 도착했을 때, 그에 대응하는 사본이 있다면 그를 이용해 요청이 처리 될 수 있음.
- cache miss = 캐시 부적중 : 대응하는 사본이 없다면 그냥 원 서버로 전달되기만 할 뿐.

### 7.5.1 재검사(Revalidation)

신선도 검사(재검사) = 원 서버 콘텐츠는 변경될 수 있기 때문에 캐시는 반드시 그들이 갖고 있는 사본이 여전히 최신인지 서버를 통해 점검해야함.

- 재검사 적중 : 서버 객체가 변경되지 않았을 경우, HTTP 304 Not Modified 응답
- 재검사 부적중 : 서버 객체가 캐시된 사본과 다르면 HTTP 200 OK 응답
- 객체 삭제 : 서버 객체가 삭제 됐다면 404 Not Found 응답, 캐시는 사본 삭제

### 7.5.2 적중률

캐시가 요청을 처리하는 비율을 캐시 적중률 혹은 문서 적중률이라 부름.

- 40% 적중률이면 웹 캐시로 괜찮은편

### 7.5.3 바이트 적중률

문서 적중률이 모든것을 말해주지 않음. 크기 때문에 전체 트래픽에 더 크게 기여하는 경우 바이트 단위 적중률 측정값을 선호하는 사람들 존재.

- 바이트 단위 적중률은 캐시를 통해 제공된 모든 바이트의 비율로 표현함.

### 7.5.4 적중과 부적중의 구별

`HTTP 200 OK`, `via 헤더 추가 정보 붙이기.`, `Date 헤더 값을 현재 시간과 비교`, `Age헤더`

## 7.6 캐시 토폴로지

캐시는 한 명의 사용자에게만 할당될 수도 있고, 수천 명의 사용자들 간에 공유될 수도 있음. 한 명에게만 할당된 캐시를 개인 전용 캐시(private cache)라 부름. 공유된 캐시는 공용 캐시(public cache)라 부름.

### 7.6.1 개인 전용 캐시

많은 에너지나 저장 공간을 필요로 하지 않음. 웹 브라우저는 개인 전용 캐시를 내장하고 있음.

### 7.6.2 공용 프락시 캐시

- 공유된 공용 캐시에서 캐시는 자주 찾는 객체를 단 한 번만 가져와 모든 요청에 대해 공유된 사본을 제공함으로써 네트워크 트래픽을 줄임.
- 수동 프락시를 지정하거나 프락시 자동설정 파일을 설정함으로 브라우저가 프락시 캐시를 사용하도록 설정할 수 있음.

### 7.6.3 프락시 캐시 계층들

자은 캐시에서 캐시 부적중이 발생했을 때 더 큰 부모 캐시가 걸러 남겨진 트래픽을 처리하도록 하는 계층을 만드는 방식이 합리적인 경우가 있음.

### 7.6.4 캐시망, 콘텐츠 라우팅, 피어링

## 7.7 캐시 처리 단계

### 1단계 요청받기

### 2단계 파싱

### 3단계 검색

### 4단계 신선도 검사

### 5단계 응답 생성

### 6단계 전송

### 7단계 로깅

### 8단계 캐시 처리 플로 차트

## 7.8 사본을 신선하게 유지하기

### 7.8.1 문서 완료

### 7.8.2 유효기관과 나이

### 7.8.3 서버 재검사

### 7.8.4 조건부 메서드와의 재검사

### 7.8.5 If-Modified-Since: 날짜 재검사

### 7.8.6 If-None-Match: 엔터티 태그 재검사

### 7.8.7 약한 검사기와 강한 검사기

### 7.8.8 언제 엔터티 태그를 사용하고 언제 Last-Modified 일시를 사용하는가

## 7.9 캐시 제어

## 7.10 캐시 제어 설정

### 7.10.1 아파치로 HTTP 헤더 제어하기

### 7.10.2 HTTP-EQUIV를 통한 HTML 캐시 제어

## 7.11 자세한 알고리즘

### 7.11.1 나이와 신선도 수명

### 7.11.2 나이 계산

### 7.11.3 완전한 나이 계산 알고리즘

## 7.12 캐시와 광고

### 7.12.1 광고 회사의 딜레마

### 7.12.2 퍼블리셔의 응답

### 7.12.3 로그 마이그레이션

### 7.12.4 적중 측정과 사용량 제한

## 7.13 추가 정보
