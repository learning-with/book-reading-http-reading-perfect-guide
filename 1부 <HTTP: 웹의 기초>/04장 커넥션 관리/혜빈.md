# 4장 커넥션 관리

## 4.1 TCP 커넥션

HTTP 통신은 TCP/IP를 통해 이루어진다.

TCP의 특징: 일단 커넥션이 맺어지면 메시지들이 손실, 손상, 순서가 바뀜이 없이 안전하게 전달됨

### 4.1.1 신뢰할 수 있는 데이터 전송 통로인 TCP

HTTP 커넥션은 몇몇 사용 규칙 제외하면 TCP 커넥션. 신뢰할만한 통신 방식 제공. 순서에 맞게 전달

### 4.2.1 TCP 스트림은 세그먼트로 나뉘어 IP패킷을 통해 전송된다

TCP는 IP패킷(IP 데이터그램)이라는 작은 조각을 통해 데이터를 전송.

HTTP가 메시지를 전송할 떄.

1. TCP 커넥션을 통해서 메시지 데이터의 내용을 순서대로 보낸다.
2. TCP는 세그먼트라는 단위로 데이터 스트림을 잘게 나눈다
3. 세그먼트를 IP패킷이라고 불리는 봉투에 담아서 인터넷을 통해 데이터를 전달한다.

IP패킷에 포함된 것

- IP 패킷 헤더
- TCP 세그먼트 헤더
- TCP 데이터 조각

### 4.1.3 TCP 커넥션 유지하기

컴퓨터는 TCP 커넥션을 여러개 가지고 있음. TCP는 포트 번호를 통해서 여러 커넥션을 유지

TCP 커넥션
<발신지 IP주소, 발신지 포트, 수신지 IP주소, 수신지 포트>

## 4.2 TCP의 성능에 대한 고려

HTTP 트랜잭션의 선능은 TCP 성능에 영향을 받는다.

### 4.2.1 HTTP 트랜잭션 지연

대부분의 HTTP지연은 TCP 네트워크 지연 떄문에 발생
HTTP 트랜잭션은 TCP 커넥션 설정, 요청 전송, 응답메시지를 보내는 것에 비하면 상당히 짧음.

HTTP 트랜잭션 지연 원인

1. DNS인프라 사용 시간
2. TCP 요청과 허가 응답
3. 요청 메시지가 서버에 의해서 처리되는 시간
4. 응답 보내느 시간

### 4.2.2 성능 관련 중요 요소

### 4.2.3 TCP 커넥션 핸드셰이크 지연

TCP 커넥션 핸드셰이크

1. 클 -> 서버 SYN
2. 서버 -> 클 SYN+ACK
3. 클 -> 서버 ACK

### 4.2.4 확인 응답 지연

확인응답: 데이터 전송이 성공적으로 진행되었따는 걸 보장해주기 위한 패킷으로 송신자에게 반환. 크기가 작아 데이터 패킷에 편승 시킨다. 그러면 편승시킬 데이터를 찾지 못하면 별도 패킷을 만들어 전송.

HTTP 동작방식은 편승할 기회가 많지 않아서 확인 응답 지연이 자주 발생.

### 4.2.5 TCP 느린 시작

TCP 커넥션은 시간이 지나면서 자체적으로 튜닝 되어서 처음에는 커넥션의 최대 속도를 제한. 갑작스러운 부하와 혼잡을 방지하는데 사용된다.

### 4.2.6 네이글 알고리즘과 TCP_NODELAY

TCP 세그먼트는 40바이트 상당의 헤더를 포함하기 때문에 아주 작은 크기의 데이터를 전송하면 오버헤드로 인한 부하가 증가할 수 있다

nagle algorithm 은 세그먼트가 ack 를 수신하거나 혹은 충분한 크기가 되기 전까지 전송하지 않고 데이터를 쌓아두었다가 전송한다

### 4.2.7 TIME_WAIT의 누적과 포트 고갈

TCP 커넥션이 종료된 후 곧바로 같은 IP adress 와 port 를 사용하는 커넥션이 생성될 경우 뒤늦게 도착한 이전 커넥션의 패킷이 존재할 경우 데이터 충돌이 발생할 수 있다

커넥션이 종료된 후, 이전 커넥션의 IP adress 와 port 를 TCP control block 에 저장해놓는다

일반적으로 2MSL (Max Segment Lifetime - 약 1분)동안 생성되지 않게 유지

## 4.3 HTTP 커넥션 관리
